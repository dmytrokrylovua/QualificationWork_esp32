import queue
from datetime import datetime
import logging

SIZE = 256  # Розмір вхідного зображення для нейронної мережі
CLASS_NUMBER = 43  # Кількість класів дорожніх знаків
BATCH_SIZE = 16  # Розмір пакету даних для навчання
EPOCHS = 75  # Кількість епох навчання
LEARNING_RATE = 0.0005  # Швидкість навчання
NUM_WORKERS = 8  # Кількість потоків для завантаження даних

SMOOTH_STOP_TIME        = 3.0
WAIT_AFTER_STOP         = 1.5
ACCELERATION_TIME       = 2.0
TURN_WAIT_TIME          = 2.0
PROHIBITED_WAIT         = 5.0
FULL_TURN_TIME          = 4.0

# КЛАСИФІКАЦІЯ ЗНАКІВ

SHAPE_CLASSES = {  # Класифікація форм знаків
    0: "круглий",
    1: "трикутний", 
    2: "квадратний",
    3: "восьмикутний"
}

COLOR_CLASSES = {  # Класифікація кольорів знаків
    0: "червоний",
    1: "синій",
    2: "жовтий", 
    3: "білий"
}

SIGN_SIZES = {
    0: 70,   # Обмеження швидкості 20 км/год
    1: 70,   # Обмеження швидкості 30 км/год
    2: 70,   # Обмеження швидкості 50 км/год
    3: 70,   # Обмеження швидкості 60 км/год
    4: 70,   # Обмеження швидкості 70 км/год
    5: 70,   # Обмеження швидкості 80 км/год
    6: 70,   # Кінець обмеження швидкості 80 км/год
    7: 70,   # Обмеження швидкості 100 км/год
    8: 70,   # Обмеження швидкості 120 км/год
    9: 70,   # Обгін заборонено
    10: 70,  # Обгін вантажним автомобілям заборонено
    11: 90,  # Перехрестя з другорядною дорогою
    12: 70,  # Головна дорога
    13: 90,  # Дати дорогу
    14: 80,  # Проїзд без зупинки заборонено
    15: 70,  # Рух заборонено
    16: 70,  # Рух вантажних автомобілів заборонено
    17: 70,  # В'їзд заборонено
    18: 90,  # Інша небезпека
    19: 90,  # Небезпечний поворот ліворуч
    20: 90,  # Небезпечний поворот праворуч
    21: 90,  # Небезпечні повороти
    22: 90,  # Нерівна дорога
    23: 90,  # Слизька дорога
    24: 90,  # Звуження дороги
    25: 90,  # Дорожні роботи
    26: 90,  # Світлофорне регулювання
    27: 90,  # Пішохідний перехід
    28: 90,  # Діти
    29: 90,  # Виїзд велосипедистів
}

SIGN_NAMES = {  # Словник назв дорожніх знаків українською мовою
    0: "Обмеження швидкості 20 км/год",
    1: "Обмеження швидкості 30 км/год",
    2: "Обмеження швидкості 50 км/год",
    3: "Обмеження швидкості 60 км/год",
    4: "Обмеження швидкості 70 км/год",
    5: "Обмеження швидкості 80 км/год",
    6: "Кінець обмеження швидкості 80 км/год",
    7: "Обмеження швидкості 100 км/год",
    8: "Обмеження швидкості 120 км/год",
    9: "Обгін заборонено",
    10: "Обгін вантажним автомобілям заборонено",
    11: "Перехрестя з другорядною дорогою",
    12: "Головна дорога",
    13: "Дати дорогу",
    14: "Проїзд без зупинки заборонено",
    15: "Рух заборонено",
    16: "Рух вантажних автомобілів заборонено",
    17: "В'їзд заборонено",
    18: "Інша небезпека",
    19: "Небезпечний поворот ліворуч",
    20: "Небезпечний поворот праворуч",
    21: "Небезпечні повороти",
    22: "Нерівна дорога",
    23: "Слизька дорога",
    24: "Звуження дороги",
    25: "Дорожні роботи",
    26: "Світлофорне регулювання",
    27: "Пішохідний перехід",
    28: "Діти",
    29: "Виїзд велосипедистів",
    30: "Снігопад",
    31: "Перехрещення з круговим рухом",
    32: "Залізничний переїзд зі шлагбаумом",
    33: "Рух праворуч",
    34: "Виїзд на набережну",
    35: "Рух прямо",
    36: "Рух прямо або праворуч",
    37: "Рух праворуч",
    38: "Залізничний переїзд без шлагбаума",
    39: "Рух прямо або ліворуч",
    40: "Рух ліворуч",
    41: "Кінець усіх заборон",
    42: "Кінець заборони обгону"
}

# ПАРАМЕТРИ КЕРУВАННЯ

SIGN_PRIORITIES = {
    14: 1,
    15: 1,
    17: 1,
    18: 2,
    26: 2,
    27: 2,
    28: 2,
    32: 2,
    33: 2,
    0: 3,
    1: 3,
    2: 3,
    3: 3,
    4: 3,
    5: 3,
    7: 3,
    8: 3,
    19: 4,
    20: 4,
    21: 4,
    22: 4,
    23: 4,
    35: 5,
    36: 5,
    37: 5,
    6: 6,
    41: 6,
    42: 6
}  # Пріоритети знаків
DEFAULT_PRIORITY = 5  # Пріоритет за замовчуванням


# ПАРАМЕТРИ ІНТЕРФЕЙСУ

UI_ACCENT_COLOR = (0, 120, 215)  # Основний колір інтерфейсу
UI_TEXT_COLOR = (255, 255, 255)  # Колір тексту
UI_BACKGROUND = (25, 25, 25)  # Колір фону
UI_WARNING_COLOR = (0, 215, 255)  # Колір попередження
UI_SUCCESS_COLOR = (0, 200, 0)  # Колір успіху
UI_DANGER_COLOR = (0, 0, 200)  # Колір небезпеки

# СИСТЕМНІ ПАРАМЕТРИ

image_extensions = ['.bmp', '.jpg', '.jpeg', '.png', '.tif', '.tiff', '.pbm', '.pgm', '.ppm']  # Підтримувані формати зображень

logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(levelname)s - %(message)s'
)


voice_notification_cooldown = 2.0  # Затримка між голосовими сповіщеннями
fallback_tts_engine = None  # Резервний двигун TTS
last_voice_notification_time = None  # Час останнього голосового сповіщення

SERVER_IP = "192.168.4.1"  # IP-адреса ESP32
BASE_URL = f"http://{SERVER_IP}"  # Базовий URL для команд

command_cooldown = 0.5  # Затримка між командами
TURN_TIME = 2.0        # Час повороту
STOP_TIME = 1.5        # Час зупинки
FORWARD_TIME = 1.0     # Час руху вперед

DEBUG_MODE = True  # Увімкнути/вимкнути режим налагодження

min_consecutive_detections = 1  # Мінімальна кількість послідовних виявлень

frame_queue = queue.Queue(maxsize=2)  # Черга для кадрів відео
results_queue = queue.Queue(maxsize=2)  # Черга для результатів обробки
stop_threads = False  # Прапор для зупинки потоків

# ПАРАМЕТРИ РОЗПІЗНАВАННЯ

max_no_detection_frames = 20  # Максимальна кількість кадрів без виявлення
DISTANCE_THRESHOLDS = [20, 40]  # Пороги відстані для сповіщень
prediction_cooldown = 0.5  # Затримка між передбаченнями
reset_distances_cooldown = 60.0  # Час скидання відстаней


no_sign_detection_count = 0  # Лічильник кадрів без виявлення знаків
announced_distances = set()  # Множина оголошених відстаней
last_sign_id = None  # ID останнього виявленого знаку
last_prediction = None  # Останнє передбачення
last_prediction_time = None  # Час останнього передбачення
last_distance = None  # Остання виміряна відстань
last_confidence = None  # Остання впевненість розпізнавання
sign_detection_count = {}  # Лічильник виявлень знаків
global_announced_cache = {}  # Кеш оголошених знаків
session_start_time = datetime.now()  # Час початку сесії
last_distance_reset_time = datetime.now()  # Час останнього скидання відстаней


# TTS
last_voice_notification_time = None
voice_notification_cooldown = 2.0
fallback_tts_engine = None

command_cooldown = 0.5  # кулдаун команд
sign_cooldown = 10.0  # кулдаун знаков